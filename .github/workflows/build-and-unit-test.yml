name: Build and Unit Test
on: 
  schedule:
    - cron: '0 8 * * *'
  # Delete once testec
  push:

jobs:
  Checkout-Code:
    runs-on: ubuntu-latest
    steps:
      - name: Recursively Checkout Repository
        uses: actions/checkout@v2
        with:
          submodules: recursive
          path: cdap
      - name: Set up Maven
        run: |
          wget -O- https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz | tar -xzv
          mv apache-maven-3.6.3 cdap/
          cd cdap
          ln -s apache-maven-3.6.3/bin/mvn mvn
          cd ..
      - name: Tar files
        run: tar -cvf cdap.tar ./cdap  
      - name: Upload Recursively Checkout REpository
        uses: actions/upload-artifact@v2
        with:
          name: updated-sources-${{env.GITHUB_RUN_ID}}
          path: cdap.tar
          retention-days: 1
  
  # From Current CI
  Unit-Tests:
    runs-on: ubuntu-latest
    needs: Checkout-Code
    steps:
      - name: Download Recursively Checkout REpository
        uses: actions/download-artifact@v2
        with:
          name: updated-sources-${{env.GITHUB_RUN_ID}}
      - name: Untar files
        run: tar -xvf cdap.tar
      - name: Set Up Java 8
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '8'
        
      - name: Run Unit Tests
        working-directory: ./cdap
        run: ./mvn test -fae -P examples,templates,unit-tests -U -V
    
  # From Current CI
  Build-Maven-Artifacts:
    runs-on: ubuntu-latest
    needs: Checkout-Code
    steps:
      - name: Download Recursively Checkout Repository
        uses: actions/download-artifact@v2
        with:
          name: updated-sources-${{env.GITHUB_RUN_ID}}
      - name: Untar files
        run: tar -xvf cdap.tar
      - name: Set Up Java 8
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '8'
      - name: Create dirs
        working-directory: ./cdap
        run: |
          mkdir -p app-artifacts
          mkdir -p security-extensions
          mkdir -p cdap/cdap-distributions/target
      - name: Install JARs to local Maven repository (cdap)
        working-directory: ./cdap
        run: MAVEN_OPTS="-Xmx4096m  -XX:MaxPermSize=256m" ./mvn install -DskipTests -B -P templates -V -U
      # Missing Deployment steps


  Build-Cdap-Standalone:
    runs-on: ubuntu-latest
    needs: Checkout-Code
    steps:
      - name: Download Recursively Checkout Repository
        uses: actions/download-artifact@v2
        with:
          name: updated-sources-${{env.GITHUB_RUN_ID}}
      - name: Untar files
        run: tar -xvf cdap.tar
      - name: Set Up Java 8
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '8'
      - name: Install JARs to local Maven repository (cdap)
        working-directory: ./cdap
        run: ./mvn clean install -DskipTests
      
      #  Missing Build Plugins
      - name: Build Standalone
        working-directory: ./cdap
        run: MAVEN_OPTS="-Xmx1024m -XX:MaxPermSize=128m" ./mvn -T2C clean  package -pl cdap-standalone,cdap-app-templates/cdap-etl -am -amd -DskipTests -P templates,dist,release,unit-tests
        #-Dadditional.artifacts.dir=$HYDRATOR_PLUGINS`

